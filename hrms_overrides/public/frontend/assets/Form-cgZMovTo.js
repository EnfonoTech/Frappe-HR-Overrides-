var C=(E,k,u)=>new Promise((T,p)=>{var m=r=>{try{e(u.next(r))}catch(i){p(i)}},w=r=>{try{e(u.throw(r))}catch(i){p(i)}},e=r=>r.done?T(r.value):Promise.resolve(r.value).then(m,w);e((u=u.apply(E,k)).next())});import{i as O,r as S,c as Z,N as g,w as f,z as U,l as y,q as h,j as $,k as F,a3 as ee,ad as A,x as R,ae as I,Q as L}from"./frappe-ui-CgmWUd__.js";import{I as ae,a as te}from"./index-2Eufh0cZ.js";import ne from"./FormView-wlFQr2-U.js";import oe from"./ExpensesTable-fEHtWQej.js";import le from"./ExpenseTaxesTable-BFxkRis9.js";import se from"./ExpenseAdvancesTable-B0tTLwKF.js";import{g as ce}from"./workflow-C9SRSeAo.js";import"./FormField-VjUN8qpQ.js";import"./Link-CsM06SXZ.js";import"./FileUploaderView-BmT9BQ7_.js";import"./formatters-DOj-qu5a.js";import"./CustomIonModal-BUNJ-L1S.js";import"./claims-BPi7fgsd.js";const Ee={__name:"Form",props:{id:{type:String,required:!1}},setup(E){const k=O("$dayjs"),u=O("$employee"),T=k().format("YYYY-MM-DD"),p=S(!1),m=E,w=[{name:"Trip Allowance",lastField:"cost_center"}],e=S({employee:u.data.name,company:u.data.company,custom_trip_location:"",custom_from:"",custom_to:"",custom_distance_in_km:0}),r=Z(()=>ce(e.value.company)),i=g({url:"hrms.api.get_doctype_fields",params:{doctype:"Expense Claim"},transform(a){return N(a).map(t=>(t.fieldname==="posting_date"&&(t.default=T),t.fieldname==="custom_expense_claim_type"&&(t.default="Trip Allowance",t.read_only=!0),P(t)))},onSuccess(a){Y.reload(),B.reload()}});i.reload();const j=g({url:"hrms.hr.doctype.expense_claim.expense_claim.get_advances",params:{employee:u.data.name},auto:!0,onSuccess(a){var n;return m.id?(n=e.value.advances)==null||n.map(t=>t.selected=!0):e.value.advances=[],a.forEach(t=>{var o,l;m.id&&((o=e.value.advances)!=null&&o.some(_=>_.employee_advance===t.name))||(l=e.value.advances)==null||l.push({employee_advance:t.name,purpose:t.purpose,posting_date:t.posting_date,advance_account:t.advance_account,advance_paid:t.paid_amount,unclaimed_amount:t.paid_amount-t.claimed_amount,allocated_amount:0})})}}),Y=g({url:"hrms.api.get_expense_approval_details",params:{employee:u.data.name},onSuccess(a){q(a)}}),B=g({url:"hrms.api.get_company_cost_center_and_expense_account",params:{company:e.value.company},onSuccess(a){e.value.cost_center=a==null?void 0:a.cost_center,e.value.payable_account=a==null?void 0:a.default_expense_claim_payable_account}});f(()=>e.value.employee,a=>{m.id&&a!==u.data.name&&K()}),f(()=>m.id&&e.value.expenses,a=>{e.value.docstatus===0&&j.reload()}),f(()=>e.value.advances,a=>{J()},{deep:!0}),f(()=>e.value.cost_center,()=>{var a,n;(n=(a=e==null?void 0:e.value)==null?void 0:a.expenses)==null||n.forEach(t=>{t.cost_center=e.value.cost_center})}),f(()=>e.value.custom_trip_location,a=>C(this,null,function*(){if(a)try{console.log("Watcher triggered with Trip Location:",a);const n=yield L("frappe.client.get_list",{doctype:"Trip Location",filters:{name:a},fields:["from","to","distancekm"],limit_page_length:1});if(console.log("Trip Location API Response:",n),!n||!n.length){console.warn("Trip Location not found:",a),e.value.custom_from="",e.value.custom_to="",e.value.custom_distance_in_km="";return}const t=n[0];e.value.custom_from=t.from||"",e.value.custom_to=t.to||"",e.value.custom_distance_in_km=t.distancekm||"",console.log("Updated expenseClaim after Trip Location fetch:",{custom_from:e.value.custom_from,custom_to:e.value.custom_to,custom_distance_in_km:e.value.custom_distance_in_km}),D()}catch(n){console.error("Error fetching Trip Location:",n)}})),f(()=>e.value.custom_holiday,()=>{console.log("Holiday changed:",e.value.custom_holiday),D()});function D(){const a=e.value.employee,n=e.value.custom_distance_in_km,t=e.value.custom_holiday==="Yes";if(console.log("Calculating trip amount with:",{employee:a,distance:n,is_holiday:t}),!a||!n){console.warn("Employee or distance not set, skipping calculation.");return}L("frappe.client.get_value",{doctype:"Employee",filters:{name:e.value.employee},fieldname:"designation"}).then(o=>{console.log("Raw response:",o);const l=o==null?void 0:o.designation;if(console.log("Extracted designation:",l),!l){console.warn("Employee designation not found for",e.value.employee);return}const _=["Pick Up Driver","Heavy Truck Driver"].includes(l),c=e.value.custom_distance_in_km,V=e.value.custom_holiday==="Yes";let s=0;_?V?c==="300-500"?s=150:c==="501-1000"?s=175:c==="1000+"&&(s=250):c==="300-500"?s=100:c==="501-1000"?s=125:c==="1000+"&&(s=185):V?c==="300-500"?s=100:c==="501-1000"?s=150:c==="1000+"&&(s=200):c==="300-500"?s=75:c==="501-1000"?s=100:c==="1000+"&&(s=140),e.value.custom_trip_amount=s,console.log("Calculated trip amount:",s)})}function N(a){const n=["naming_series","task","taxes_and_charges_sb","advance_payments_sb","accounting_dimensions_section","transactions_section","accounting_details"],t=["employee","employee_name","department","remark","is_paid","mode_of_payment","clearance_date","approval_status"];return m.id||n.push(...t),a.filter(o=>!n.includes(o.fieldname))}function P(a){return["posting_date","grand_total"].includes(a.fieldname)&&(a.hidden=!0),a.fieldname==="cost_center"&&(a.hidden=!0),a.fieldname==="payable_account"&&(a.hidden=!0),a.fieldname==="project"&&(a.hidden=!0),a.fieldname==="payable_account"?a.linkFilters={report_type:"Balance Sheet",account_type:"Payable",company:e.value.company,is_group:0}:a.fieldname==="cost_center"?a.linkFilters={company:e.value.company,is_group:0}:a.fieldname==="project"&&(a.linkFilters={company:e.value.company}),a}function q(a){var t;const n=(t=i.data)==null?void 0:t.find(o=>o.fieldname==="expense_approver");n.reqd=a==null?void 0:a.is_mandatory,n.documentList=a==null?void 0:a.department_approvers.map(o=>({label:o.full_name?`${o.name} : ${o.full_name}`:o.name,value:o.name})),e.value.expense_approver=a==null?void 0:a.expense_approver,e.value.expense_approver_name=a==null?void 0:a.expense_approver_name}function H(a){e.value.expenses||(e.value.expenses=[]),e.value.expenses.push(a),b(),d(),v()}function M(a,n){e.value.expenses[n]=a,b(),d(),v()}function z(a){e.value.expenses.splice(a,1),b(),d(),v()}function G(a){e.value.taxes||(e.value.taxes=[]),e.value.taxes.push(a),d(),v()}function Q(a,n){e.value.taxes[n]=a,d(),v()}function W(a){e.value.taxes.splice(a,1),d(),v()}function b(){var t,o;let a=0,n=0;(o=(t=e.value)==null?void 0:t.expenses)==null||o.forEach(l=>{a+=parseFloat(l.amount),n+=parseFloat(l.sanctioned_amount)}),e.value.total_claimed_amount=a,e.value.total_sanctioned_amount=n,x()}function d(){var n,t;let a=0;(t=(n=e.value)==null?void 0:n.taxes)==null||t.forEach(o=>{o.rate&&(o.tax_amount=parseFloat(e.value.total_sanctioned_amount)*parseFloat(o.rate/100)),o.total=parseFloat(o.tax_amount)+parseFloat(e.value.total_sanctioned_amount),a+=parseFloat(o.tax_amount)}),e.value.total_taxes_and_charges=a,x()}function x(){e.value.grand_total=parseFloat(e.value.total_sanctioned_amount||0)+parseFloat(e.value.total_taxes_and_charges||0)-parseFloat(e.value.total_advance_amount||0)}function v(){var t,o;let a=parseFloat(e.value.total_sanctioned_amount)+parseFloat(e.value.total_taxes_and_charges),n=0;(o=(t=e==null?void 0:e.value)==null?void 0:t.advances)==null||o.forEach(l=>{a>=parseFloat(l.unclaimed_amount)?(l.allocated_amount=parseFloat(l.unclaimed_amount),a-=parseFloat(l.allocated_amount)):(l.allocated_amount=a,a=0),l.selected=l.allocated_amount>0,n+=parseFloat(l.allocated_amount)}),e.value.total_advance_amount=n,x()}function J(){var n,t;let a=0;(t=(n=e==null?void 0:e.value)==null?void 0:n.advances)==null||t.forEach(o=>{o.selected&&(a+=parseFloat(o.allocated_amount))}),e.value.total_advance_amount=a,x()}function K(){e.value.expense_approver!==u.data.user_id&&(i.data.map(a=>a.read_only=!0),p.value=!0)}function X(){var a,n,t,o,l;(a=e==null?void 0:e.value)!=null&&a.advances&&(e.value.advances=(t=(n=e==null?void 0:e.value)==null?void 0:n.advances)==null?void 0:t.filter(_=>_.selected),(l=(o=e==null?void 0:e.value)==null?void 0:o.expenses)==null||l.forEach(_=>{_.cost_center=e.value.cost_center}))}return(a,n)=>($(),U(h(ae),null,{default:y(()=>[F(h(te),{fullscreen:!0},{default:y(()=>[h(i).data?($(),U(ne,{key:0,doctype:"Expense Claim",modelValue:e.value,"onUpdate:modelValue":n[3]||(n[3]=t=>e.value=t),isSubmittable:!0,fields:h(i).data,id:m.id,tabbedView:!0,tabs:w,showAttachmentView:!1,onValidateForm:X},{expenses:y(({isFormReadOnly:t})=>[A(R("div",null,[F(oe,{expenseClaim:e.value,"onUpdate:expenseClaim":n[0]||(n[0]=o=>e.value=o),currency:r.value,isReadOnly:p.value||t,onAddExpenseItem:H,onUpdateExpenseItem:M,onDeleteExpenseItem:z},null,8,["expenseClaim","currency","isReadOnly"])],512),[[I,!1]])]),taxes:y(({isFormReadOnly:t})=>[A(R("div",null,[F(le,{expenseClaim:e.value,"onUpdate:expenseClaim":n[1]||(n[1]=o=>e.value=o),currency:r.value,isReadOnly:p.value||t,onAddExpenseTax:G,onUpdateExpenseTax:Q,onDeleteExpenseTax:W},null,8,["expenseClaim","currency","isReadOnly"])],512),[[I,!1]])]),advances:y(({isFormReadOnly:t})=>[A(R("div",null,[F(se,{expenseClaim:e.value,"onUpdate:expenseClaim":n[2]||(n[2]=o=>e.value=o),currency:r.value,isReadOnly:p.value||t},null,8,["expenseClaim","currency","isReadOnly"])],512),[[I,!1]])]),_:1},8,["modelValue","fields","id"])):ee("",!0)]),_:1})]),_:1}))}};export{Ee as default};
//# sourceMappingURL=Form-cgZMovTo.js.map
