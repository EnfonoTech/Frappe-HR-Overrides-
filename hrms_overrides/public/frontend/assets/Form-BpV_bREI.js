import{i as T,r as k,c as f,N as x,w as i,z as g,l as _,q as y,j as E,k as w,a3 as D,ad as V,x as I,ae as R}from"./frappe-ui-CgmWUd__.js";import{I as W,a as X}from"./index-2Eufh0cZ.js";import Z from"./FormView-wlFQr2-U.js";import ee from"./ExpensesTable-fEHtWQej.js";import ae from"./ExpenseTaxesTable-BFxkRis9.js";import te from"./ExpenseAdvancesTable-B0tTLwKF.js";import{g as ne}from"./workflow-C9SRSeAo.js";import"./FormField-VjUN8qpQ.js";import"./Link-CsM06SXZ.js";import"./FileUploaderView-BmT9BQ7_.js";import"./formatters-DOj-qu5a.js";import"./CustomIonModal-BUNJ-L1S.js";import"./claims-BPi7fgsd.js";const xe={__name:"Form",props:{id:{type:String,required:!1}},setup(O){const S=T("$dayjs"),u=T("$employee"),$=S().format("YYYY-MM-DD"),d=k(!1),c=O,j=f(()=>{const e=a.value.docstatus===0,t=a.value.custom_expense_claim_type==="Trip Allowance";return[{name:e&&t?"Trip Allowance":"Expenses",lastField:"cost_center"}]}),U=f(()=>{const e=a.value.docstatus===0,t=a.value.custom_expense_claim_type==="Trip Allowance";return e&&t?"trip-allowance-form":"default-expense-form"}),a=k({employee:u.data.name,company:u.data.company}),h=f(()=>ne(a.value.company)),A=f(()=>a.value.docstatus===0&&a.value.custom_expense_claim_type==="Trip Allowance"),l=x({url:"hrms.api.get_doctype_fields",params:{doctype:"Expense Claim"},transform(e){return Y(e).map(n=>(n.fieldname==="posting_date"&&(n.default=$),b(n)))},onSuccess(e){B.reload(),N.reload()}});l.reload();const C=x({url:"hrms.hr.doctype.expense_claim.expense_claim.get_advances",params:{employee:u.data.name},auto:!0,onSuccess(e){var t;return c.id?(t=a.value.advances)==null||t.map(n=>n.selected=!0):a.value.advances=[],e.forEach(n=>{var o,s;c.id&&((o=a.value.advances)!=null&&o.some(m=>m.employee_advance===n.name))||(s=a.value.advances)==null||s.push({employee_advance:n.name,purpose:n.purpose,posting_date:n.posting_date,advance_account:n.advance_account,advance_paid:n.paid_amount,unclaimed_amount:n.paid_amount-n.claimed_amount,allocated_amount:0})})}}),B=x({url:"hrms.api.get_expense_approval_details",params:{employee:u.data.name},onSuccess(e){q(e)}}),N=x({url:"hrms.api.get_company_cost_center_and_expense_account",params:{company:a.value.company},onSuccess(e){a.value.cost_center=e==null?void 0:e.cost_center,a.value.payable_account=e==null?void 0:e.default_expense_claim_payable_account}});i(()=>a.value.employee,e=>{c.id&&e!==u.data.name&&J()}),i(()=>c.id&&a.value.expenses,e=>{a.value.docstatus===0&&C.reload()}),i(()=>a.value.custom_expense_claim_type,()=>{l.data=l.data.map(b)}),i(()=>a.value.advances,e=>{H()},{deep:!0}),i(()=>a.value.cost_center,()=>{var e,t;(t=(e=a==null?void 0:a.value)==null?void 0:e.expenses)==null||t.forEach(n=>{n.cost_center=a.value.cost_center})});function Y(e){const t=["naming_series","task","taxes_and_charges_sb","advance_payments_sb","accounting_dimensions_section","transactions_section","accounting_details"],n=["employee_name","posting_date","approval_status"];return c.id||t.push(...n),e.filter(o=>!t.includes(o.fieldname))}function b(e){const t=a.value.docstatus===0,n=a.value.custom_expense_claim_type==="Trip Allowance";return["custom_from","custom_to","custom_expense_claim_type","custom_distance_in_km","custom_jobsitehospital_name","custom_trip_amount","custom_number_of_trip","custom_holiday","custom_trip_location"].includes(e.fieldname)&&(e.hidden=!(t&&n)),["custom_expense_claim_type"].includes(e.fieldname)&&(e.read_only=t&&n),["total_sanctioned_amount","total_claimed_amount"].includes(e.fieldname)&&(e.hidden=t&&n),["mode_of_payment","grand_total","is_paid","clearance_date","remark","employee","department"].includes(e.fieldname)&&(e.hidden=!0),["posting_date"].includes(e.fieldname)&&(e.read_only=!0),e.fieldname==="cost_center"&&(e.hidden=!0),e.fieldname==="payable_account"&&(e.hidden=!0),e.fieldname==="project"&&(e.hidden=!0),e.fieldname==="payable_account"?e.linkFilters={report_type:"Balance Sheet",account_type:"Payable",company:a.value.company,is_group:0}:e.fieldname==="cost_center"?e.linkFilters={company:a.value.company,is_group:0}:e.fieldname==="project"&&(e.linkFilters={company:a.value.company}),e}function q(e){var n;const t=(n=l.data)==null?void 0:n.find(o=>o.fieldname==="expense_approver");t.reqd=e==null?void 0:e.is_mandatory,t.documentList=e==null?void 0:e.department_approvers.map(o=>({label:o.full_name?`${o.name} : ${o.full_name}`:o.name,value:o.name})),a.value.expense_approver=e==null?void 0:e.expense_approver,a.value.expense_approver_name=e==null?void 0:e.expense_approver_name}function M(e){a.value.expenses||(a.value.expenses=[]),a.value.expenses.push(e),F(),r(),p()}function P(e,t){a.value.expenses[t]=e,F(),r(),p()}function z(e){a.value.expenses.splice(e,1),F(),r(),p()}function G(e){a.value.taxes||(a.value.taxes=[]),a.value.taxes.push(e),r(),p()}function K(e,t){a.value.taxes[t]=e,r(),p()}function L(e){a.value.taxes.splice(e,1),r(),p()}function F(){var n,o;let e=0,t=0;(o=(n=a.value)==null?void 0:n.expenses)==null||o.forEach(s=>{e+=parseFloat(s.amount),t+=parseFloat(s.sanctioned_amount)}),a.value.total_claimed_amount=e,a.value.total_sanctioned_amount=t,v()}function r(){var t,n;let e=0;(n=(t=a.value)==null?void 0:t.taxes)==null||n.forEach(o=>{o.rate&&(o.tax_amount=parseFloat(a.value.total_sanctioned_amount)*parseFloat(o.rate/100)),o.total=parseFloat(o.tax_amount)+parseFloat(a.value.total_sanctioned_amount),e+=parseFloat(o.tax_amount)}),a.value.total_taxes_and_charges=e,v()}function v(){a.value.grand_total=parseFloat(a.value.total_sanctioned_amount||0)+parseFloat(a.value.total_taxes_and_charges||0)-parseFloat(a.value.total_advance_amount||0)}function p(){var n,o;let e=parseFloat(a.value.total_sanctioned_amount)+parseFloat(a.value.total_taxes_and_charges),t=0;(o=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null||o.forEach(s=>{e>=parseFloat(s.unclaimed_amount)?(s.allocated_amount=parseFloat(s.unclaimed_amount),e-=parseFloat(s.allocated_amount)):(s.allocated_amount=e,e=0),s.selected=s.allocated_amount>0,t+=parseFloat(s.allocated_amount)}),a.value.total_advance_amount=t,v()}function H(){var t,n;let e=0;(n=(t=a==null?void 0:a.value)==null?void 0:t.advances)==null||n.forEach(o=>{o.selected&&(e+=parseFloat(o.allocated_amount))}),a.value.total_advance_amount=e,v()}function J(){a.value.expense_approver!==u.data.user_id&&(l.data.map(e=>e.read_only=!0),d.value=!0)}function Q(){var e,t,n,o,s;(e=a==null?void 0:a.value)!=null&&e.advances&&(a.value.advances=(n=(t=a==null?void 0:a.value)==null?void 0:t.advances)==null?void 0:n.filter(m=>m.selected),(s=(o=a==null?void 0:a.value)==null?void 0:o.expenses)==null||s.forEach(m=>{m.cost_center=a.value.cost_center}))}return(e,t)=>(E(),g(y(W),null,{default:_(()=>[w(y(X),{fullscreen:!0},{default:_(()=>[y(l).data?(E(),g(Z,{key:U.value,doctype:"Expense Claim",modelValue:a.value,"onUpdate:modelValue":t[3]||(t[3]=n=>a.value=n),isSubmittable:!0,fields:y(l).data,id:c.id,tabbedView:!0,tabs:j.value,showAttachmentView:!A.value,onValidateForm:Q},{expenses:_(({isFormReadOnly:n})=>[A.value?D("",!0):(E(),g(ee,{key:0,expenseClaim:a.value,"onUpdate:expenseClaim":t[0]||(t[0]=o=>a.value=o),currency:h.value,isReadOnly:d.value||n,onAddExpenseItem:M,onUpdateExpenseItem:P,onDeleteExpenseItem:z},null,8,["expenseClaim","currency","isReadOnly"]))]),taxes:_(({isFormReadOnly:n})=>[V(I("div",null,[w(ae,{expenseClaim:a.value,"onUpdate:expenseClaim":t[1]||(t[1]=o=>a.value=o),currency:h.value,isReadOnly:d.value||n,onAddExpenseTax:G,onUpdateExpenseTax:K,onDeleteExpenseTax:L},null,8,["expenseClaim","currency","isReadOnly"])],512),[[R,!1]])]),advances:_(({isFormReadOnly:n})=>[V(I("div",null,[w(te,{expenseClaim:a.value,"onUpdate:expenseClaim":t[2]||(t[2]=o=>a.value=o),currency:h.value,isReadOnly:d.value||n},null,8,["expenseClaim","currency","isReadOnly"])],512),[[R,!1]])]),_:1},8,["modelValue","fields","id","tabs","showAttachmentView"])):D("",!0)]),_:1})]),_:1}))}};export{xe as default};
//# sourceMappingURL=Form-BpV_bREI.js.map
