import{i as T,r as k,c as F,N as f,w as _,z as g,l as i,q as y,j as E,k as w,a3 as V,ad as D,x as I,ae as R}from"./frappe-ui-CgmWUd__.js";import{I as W,a as X}from"./index-B6FRLPIi.js";import Z from"./FormView-BQIrwm-y.js";import ee from"./ExpensesTable-8bo6EjrI.js";import ae from"./ExpenseTaxesTable-Dc_hHo59.js";import te from"./ExpenseAdvancesTable-B4cckDEj.js";import{g as ne}from"./workflow-BjdAssIw.js";import"./FormField-VjUN8qpQ.js";import"./Link-CsM06SXZ.js";import"./FileUploaderView-Y7HT3JPL.js";import"./formatters-C1Z8-ffl.js";import"./CustomIonModal-DHssWtrZ.js";import"./claims-B7Ri4WeD.js";const ye={__name:"Form",props:{id:{type:String,required:!1}},setup(O){const S=T("$dayjs"),u=T("$employee"),$=S().format("YYYY-MM-DD"),d=k(!1),c=O,j=[{name:"Food Allowance",lastField:"cost_center"}],U=F(()=>{const e=a.value.docstatus===0,n=a.value.custom_expense_claim_type==="Trip Allowance";return e&&n?"trip-allowance-form":"default-expense-form"}),a=k({employee:u.data.name,company:u.data.company}),x=F(()=>ne(a.value.company)),A=F(()=>a.value.docstatus===0&&a.value.custom_expense_claim_type==="Trip Allowance"),l=f({url:"hrms.api.get_doctype_fields",params:{doctype:"Expense Claim"},transform(e){return Y(e).map(t=>(t.fieldname==="posting_date"&&(t.default=$),t.fieldname==="custom_expense_claim_type"&&(t.default="Food Allowance",t.read_only=!0),b(t)))},onSuccess(e){B.reload(),N.reload()}});l.reload();const C=f({url:"hrms.hr.doctype.expense_claim.expense_claim.get_advances",params:{employee:u.data.name},auto:!0,onSuccess(e){var n;return c.id?(n=a.value.advances)==null||n.map(t=>t.selected=!0):a.value.advances=[],e.forEach(t=>{var o,s;c.id&&((o=a.value.advances)!=null&&o.some(m=>m.employee_advance===t.name))||(s=a.value.advances)==null||s.push({employee_advance:t.name,purpose:t.purpose,posting_date:t.posting_date,advance_account:t.advance_account,advance_paid:t.paid_amount,unclaimed_amount:t.paid_amount-t.claimed_amount,allocated_amount:0})})}}),B=f({url:"hrms.api.get_expense_approval_details",params:{employee:u.data.name},onSuccess(e){q(e)}}),N=f({url:"hrms.api.get_company_cost_center_and_expense_account",params:{company:a.value.company},onSuccess(e){a.value.cost_center=e==null?void 0:e.cost_center,a.value.payable_account=e==null?void 0:e.default_expense_claim_payable_account}});_(()=>a.value.employee,e=>{c.id&&e!==u.data.name&&J()}),_(()=>c.id&&a.value.expenses,e=>{a.value.docstatus===0&&C.reload()}),_(()=>a.value.custom_expense_claim_type,()=>{l.data=l.data.map(b)}),_(()=>a.value.advances,e=>{H()},{deep:!0}),_(()=>a.value.cost_center,()=>{var e,n;(n=(e=a==null?void 0:a.value)==null?void 0:e.expenses)==null||n.forEach(t=>{t.cost_center=a.value.cost_center})});function Y(e){const n=["naming_series","task","taxes_and_charges_sb","advance_payments_sb","accounting_dimensions_section","transactions_section","accounting_details"],t=["employee_name","posting_date","approval_status"];return c.id||n.push(...t),e.filter(o=>!n.includes(o.fieldname))}function b(e){const n=a.value.docstatus===0,t=a.value.custom_expense_claim_type==="Trip Allowance";return["custom_from","custom_to","custom_expense_claim_type","custom_distance_in_km","custom_jobsitehospital_name","custom_trip_amount","custom_number_of_trip","custom_holiday","custom_trip_location"].includes(e.fieldname)&&(e.hidden=!(n&&t)),["custom_expense_claim_type"].includes(e.fieldname)&&(e.read_only=n&&t),["total_sanctioned_amount","total_claimed_amount"].includes(e.fieldname)&&(e.hidden=n&&t),["mode_of_payment","grand_total","is_paid","clearance_date","remark","employee","department"].includes(e.fieldname)&&(e.hidden=!0),["posting_date"].includes(e.fieldname)&&(e.read_only=!0),e.fieldname==="cost_center"&&(e.hidden=!0),e.fieldname==="payable_account"&&(e.hidden=!0),e.fieldname==="project"&&(e.hidden=!0),e.fieldname==="payable_account"?e.linkFilters={report_type:"Balance Sheet",account_type:"Payable",company:a.value.company,is_group:0}:e.fieldname==="cost_center"?e.linkFilters={company:a.value.company,is_group:0}:e.fieldname==="project"&&(e.linkFilters={company:a.value.company}),e}function q(e){var t;const n=(t=l.data)==null?void 0:t.find(o=>o.fieldname==="expense_approver");n.reqd=e==null?void 0:e.is_mandatory,n.documentList=e==null?void 0:e.department_approvers.map(o=>({label:o.full_name?`${o.name} : ${o.full_name}`:o.name,value:o.name})),a.value.expense_approver=e==null?void 0:e.expense_approver,a.value.expense_approver_name=e==null?void 0:e.expense_approver_name}function M(e){a.value.expenses||(a.value.expenses=[]),a.value.expenses.push(e),h(),r(),p()}function P(e,n){a.value.expenses[n]=e,h(),r(),p()}function z(e){a.value.expenses.splice(e,1),h(),r(),p()}function G(e){a.value.taxes||(a.value.taxes=[]),a.value.taxes.push(e),r(),p()}function K(e,n){a.value.taxes[n]=e,r(),p()}function L(e){a.value.taxes.splice(e,1),r(),p()}function h(){var t,o;let e=0,n=0;(o=(t=a.value)==null?void 0:t.expenses)==null||o.forEach(s=>{e+=parseFloat(s.amount),n+=parseFloat(s.sanctioned_amount)}),a.value.total_claimed_amount=e,a.value.total_sanctioned_amount=n,v()}function r(){var n,t;let e=0;(t=(n=a.value)==null?void 0:n.taxes)==null||t.forEach(o=>{o.rate&&(o.tax_amount=parseFloat(a.value.total_sanctioned_amount)*parseFloat(o.rate/100)),o.total=parseFloat(o.tax_amount)+parseFloat(a.value.total_sanctioned_amount),e+=parseFloat(o.tax_amount)}),a.value.total_taxes_and_charges=e,v()}function v(){a.value.grand_total=parseFloat(a.value.total_sanctioned_amount||0)+parseFloat(a.value.total_taxes_and_charges||0)-parseFloat(a.value.total_advance_amount||0)}function p(){var t,o;let e=parseFloat(a.value.total_sanctioned_amount)+parseFloat(a.value.total_taxes_and_charges),n=0;(o=(t=a==null?void 0:a.value)==null?void 0:t.advances)==null||o.forEach(s=>{e>=parseFloat(s.unclaimed_amount)?(s.allocated_amount=parseFloat(s.unclaimed_amount),e-=parseFloat(s.allocated_amount)):(s.allocated_amount=e,e=0),s.selected=s.allocated_amount>0,n+=parseFloat(s.allocated_amount)}),a.value.total_advance_amount=n,v()}function H(){var n,t;let e=0;(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null||t.forEach(o=>{o.selected&&(e+=parseFloat(o.allocated_amount))}),a.value.total_advance_amount=e,v()}function J(){a.value.expense_approver!==u.data.user_id&&(l.data.map(e=>e.read_only=!0),d.value=!0)}function Q(){var e,n,t,o,s;(e=a==null?void 0:a.value)!=null&&e.advances&&(a.value.advances=(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null?void 0:t.filter(m=>m.selected),(s=(o=a==null?void 0:a.value)==null?void 0:o.expenses)==null||s.forEach(m=>{m.cost_center=a.value.cost_center}))}return(e,n)=>(E(),g(y(W),null,{default:i(()=>[w(y(X),{fullscreen:!0},{default:i(()=>[y(l).data?(E(),g(Z,{key:U.value,doctype:"Expense Claim",modelValue:a.value,"onUpdate:modelValue":n[3]||(n[3]=t=>a.value=t),isSubmittable:!0,fields:y(l).data,id:c.id,tabbedView:!0,tabs:j,showAttachmentView:!A.value,onValidateForm:Q},{expenses:i(({isFormReadOnly:t})=>[A.value?V("",!0):(E(),g(ee,{key:0,expenseClaim:a.value,"onUpdate:expenseClaim":n[0]||(n[0]=o=>a.value=o),currency:x.value,isReadOnly:d.value||t,onAddExpenseItem:M,onUpdateExpenseItem:P,onDeleteExpenseItem:z},null,8,["expenseClaim","currency","isReadOnly"]))]),taxes:i(({isFormReadOnly:t})=>[D(I("div",null,[w(ae,{expenseClaim:a.value,"onUpdate:expenseClaim":n[1]||(n[1]=o=>a.value=o),currency:x.value,isReadOnly:d.value||t,onAddExpenseTax:G,onUpdateExpenseTax:K,onDeleteExpenseTax:L},null,8,["expenseClaim","currency","isReadOnly"])],512),[[R,!1]])]),advances:i(({isFormReadOnly:t})=>[D(I("div",null,[w(te,{expenseClaim:a.value,"onUpdate:expenseClaim":n[2]||(n[2]=o=>a.value=o),currency:x.value,isReadOnly:d.value||t},null,8,["expenseClaim","currency","isReadOnly"])],512),[[R,!1]])]),_:1},8,["modelValue","fields","id","showAttachmentView"])):V("",!0)]),_:1})]),_:1}))}};export{ye as default};
//# sourceMappingURL=Form-CHBXdvMq.js.map
