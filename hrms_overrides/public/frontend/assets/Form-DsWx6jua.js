import{i as T,r as w,c as H,N as v,w as f,z as A,l as i,q as x,j as k,k as y,a3 as J,ad as h,x as E,ae as b}from"./frappe-ui-X7q4Y2QI.js";import{I as K,a as Q}from"./index-EIkbBE6I.js";import W from"./FormView-BdySl15C.js";import X from"./ExpensesTable-Be9OrmlR.js";import Z from"./ExpenseTaxesTable-CnNqw_uK.js";import ee from"./ExpenseAdvancesTable-DeKgCkS-.js";import{g as ae}from"./workflow-DjkMI4GD.js";import"./FormField-Bqyp0dEV.js";import"./Link-Bw22P_6Z.js";import"./FileUploaderView-Dr3wact2.js";import"./formatters-D4gK48Qg.js";import"./CustomIonModal-Cq005JGe.js";import"./claims-DMrX5lQs.js";const ve={__name:"Form",props:{id:{type:String,required:!1}},setup(I){const R=T("$dayjs"),s=T("$employee"),V=R().format("YYYY-MM-DD"),_=w(!1),u=I,O=[{name:"Trip Allowance",lastField:"cost_center"}],a=w({employee:s.data.name,company:s.data.company}),F=H(()=>ae(a.value.company)),p=v({url:"hrms.api.get_doctype_fields",params:{doctype:"Expense Claim"},transform(e){return j(e).map(t=>(t.fieldname==="posting_date"&&(t.default=V),t.fieldname==="custom_expense_claim_type"&&(t.default="Trip Allowance",t.read_only=!0),U(t)))},onSuccess(e){$.reload(),D.reload()}});p.reload();const S=v({url:"hrms.hr.doctype.expense_claim.expense_claim.get_advances",params:{employee:s.data.name},auto:!0,onSuccess(e){var n;return u.id?(n=a.value.advances)==null||n.map(t=>t.selected=!0):a.value.advances=[],e.forEach(t=>{var o,l;u.id&&((o=a.value.advances)!=null&&o.some(m=>m.employee_advance===t.name))||(l=a.value.advances)==null||l.push({employee_advance:t.name,purpose:t.purpose,posting_date:t.posting_date,advance_account:t.advance_account,advance_paid:t.paid_amount,unclaimed_amount:t.paid_amount-t.claimed_amount,allocated_amount:0})})}}),$=v({url:"hrms.api.get_expense_approval_details",params:{employee:s.data.name},onSuccess(e){C(e)}}),D=v({url:"hrms.api.get_company_cost_center_and_expense_account",params:{company:a.value.company},onSuccess(e){a.value.cost_center=e==null?void 0:e.cost_center,a.value.payable_account=e==null?void 0:e.default_expense_claim_payable_account}});f(()=>a.value.employee,e=>{u.id&&e!==s.data.name&&G()}),f(()=>u.id&&a.value.expenses,e=>{a.value.docstatus===0&&S.reload()}),f(()=>a.value.advances,e=>{z()},{deep:!0}),f(()=>a.value.cost_center,()=>{var e,n;(n=(e=a==null?void 0:a.value)==null?void 0:e.expenses)==null||n.forEach(t=>{t.cost_center=a.value.cost_center})});function j(e){const n=["naming_series","task","taxes_and_charges_sb","advance_payments_sb","accounting_dimensions_section","transactions_section","accounting_details"],t=["employee","employee_name","department","remark","is_paid","mode_of_payment","clearance_date","approval_status"];return u.id||n.push(...t),e.filter(o=>!n.includes(o.fieldname))}function U(e){return["posting_date","grand_total"].includes(e.fieldname)&&(e.hidden=!0),e.fieldname==="cost_center"&&(e.hidden=!0),e.fieldname==="payable_account"&&(e.hidden=!0),e.fieldname==="project"&&(e.hidden=!0),e.fieldname==="payable_account"?e.linkFilters={report_type:"Balance Sheet",account_type:"Payable",company:a.value.company,is_group:0}:e.fieldname==="cost_center"?e.linkFilters={company:a.value.company,is_group:0}:e.fieldname==="project"&&(e.linkFilters={company:a.value.company}),e}function C(e){var t;const n=(t=p.data)==null?void 0:t.find(o=>o.fieldname==="expense_approver");n.reqd=e==null?void 0:e.is_mandatory,n.documentList=e==null?void 0:e.department_approvers.map(o=>({label:o.full_name?`${o.name} : ${o.full_name}`:o.name,value:o.name})),a.value.expense_approver=e==null?void 0:e.expense_approver,a.value.expense_approver_name=e==null?void 0:e.expense_approver_name}function B(e){a.value.expenses||(a.value.expenses=[]),a.value.expenses.push(e),g(),r(),c()}function N(e,n){a.value.expenses[n]=e,g(),r(),c()}function Y(e){a.value.expenses.splice(e,1),g(),r(),c()}function q(e){a.value.taxes||(a.value.taxes=[]),a.value.taxes.push(e),r(),c()}function M(e,n){a.value.taxes[n]=e,r(),c()}function P(e){a.value.taxes.splice(e,1),r(),c()}function g(){var t,o;let e=0,n=0;(o=(t=a.value)==null?void 0:t.expenses)==null||o.forEach(l=>{e+=parseFloat(l.amount),n+=parseFloat(l.sanctioned_amount)}),a.value.total_claimed_amount=e,a.value.total_sanctioned_amount=n,d()}function r(){var n,t;let e=0;(t=(n=a.value)==null?void 0:n.taxes)==null||t.forEach(o=>{o.rate&&(o.tax_amount=parseFloat(a.value.total_sanctioned_amount)*parseFloat(o.rate/100)),o.total=parseFloat(o.tax_amount)+parseFloat(a.value.total_sanctioned_amount),e+=parseFloat(o.tax_amount)}),a.value.total_taxes_and_charges=e,d()}function d(){a.value.grand_total=parseFloat(a.value.total_sanctioned_amount||0)+parseFloat(a.value.total_taxes_and_charges||0)-parseFloat(a.value.total_advance_amount||0)}function c(){var t,o;let e=parseFloat(a.value.total_sanctioned_amount)+parseFloat(a.value.total_taxes_and_charges),n=0;(o=(t=a==null?void 0:a.value)==null?void 0:t.advances)==null||o.forEach(l=>{e>=parseFloat(l.unclaimed_amount)?(l.allocated_amount=parseFloat(l.unclaimed_amount),e-=parseFloat(l.allocated_amount)):(l.allocated_amount=e,e=0),l.selected=l.allocated_amount>0,n+=parseFloat(l.allocated_amount)}),a.value.total_advance_amount=n,d()}function z(){var n,t;let e=0;(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null||t.forEach(o=>{o.selected&&(e+=parseFloat(o.allocated_amount))}),a.value.total_advance_amount=e,d()}function G(){a.value.expense_approver!==s.data.user_id&&(p.data.map(e=>e.read_only=!0),_.value=!0)}function L(){var e,n,t,o,l;(e=a==null?void 0:a.value)!=null&&e.advances&&(a.value.advances=(t=(n=a==null?void 0:a.value)==null?void 0:n.advances)==null?void 0:t.filter(m=>m.selected),(l=(o=a==null?void 0:a.value)==null?void 0:o.expenses)==null||l.forEach(m=>{m.cost_center=a.value.cost_center}))}return(e,n)=>(k(),A(x(K),null,{default:i(()=>[y(x(Q),{fullscreen:!0},{default:i(()=>[x(p).data?(k(),A(W,{key:0,doctype:"Expense Claim",modelValue:a.value,"onUpdate:modelValue":n[3]||(n[3]=t=>a.value=t),isSubmittable:!0,fields:x(p).data,id:u.id,tabbedView:!0,tabs:O,showAttachmentView:!1,onValidateForm:L},{expenses:i(({isFormReadOnly:t})=>[h(E("div",null,[y(X,{expenseClaim:a.value,"onUpdate:expenseClaim":n[0]||(n[0]=o=>a.value=o),currency:F.value,isReadOnly:_.value||t,onAddExpenseItem:B,onUpdateExpenseItem:N,onDeleteExpenseItem:Y},null,8,["expenseClaim","currency","isReadOnly"])],512),[[b,!1]])]),taxes:i(({isFormReadOnly:t})=>[h(E("div",null,[y(Z,{expenseClaim:a.value,"onUpdate:expenseClaim":n[1]||(n[1]=o=>a.value=o),currency:F.value,isReadOnly:_.value||t,onAddExpenseTax:q,onUpdateExpenseTax:M,onDeleteExpenseTax:P},null,8,["expenseClaim","currency","isReadOnly"])],512),[[b,!1]])]),advances:i(({isFormReadOnly:t})=>[h(E("div",null,[y(ee,{expenseClaim:a.value,"onUpdate:expenseClaim":n[2]||(n[2]=o=>a.value=o),currency:F.value,isReadOnly:_.value||t},null,8,["expenseClaim","currency","isReadOnly"])],512),[[b,!1]])]),_:1},8,["modelValue","fields","id"])):J("",!0)]),_:1})]),_:1}))}};export{ve as default};
//# sourceMappingURL=Form-DsWx6jua.js.map
